<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="apple-touch-icon" sizes="76x76" href="/public/img/apple-icon.png">
        <link rel="icon" type="image/png" href="/public/img/favicon.png">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <title>Adventurethon DB</title>
        <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />

        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
        <!-- /* NowUI Kit Theme License: https://github.com/creativetimofficial/now-ui-kit/blob/master/LICENSE.md */ -->
        <link href="/public/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/public/css/now-ui-kit.css" rel="stylesheet" />
        <link href="/public/css/app.css" rel="stylesheet" />
    </head>
    <body class="login-page">
        <!-- Navbar -->
        <nav class="navbar navbar-toggleable-md bg-primary fixed-top navbar-transparent " color-on-scroll="500">
            <div class="container">
                <div class="navbar-translate">
                    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-bar bar1"></span>
                        <span class="navbar-toggler-bar bar2"></span>
                        <span class="navbar-toggler-bar bar3"></span>
                    </button>
                    <a class="navbar-brand" href="#">
                       Adventurethon DB
                    </a>
                </div>
                <div class="collapse navbar-collapse justify-content-end" id="navigation" data-nav-image="/public/img/blurred-image-1.jpg">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="https://adventurethon.com.au/">Website</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" rel="tooltip" title="Watch us on YouTube" data-placement="bottom" href="https://www.youtube.com/user/adventurethon" target="_blank">
                                <i class="fa fa-youtube"></i>
                                <p class="hidden-lg-up">YouTube</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" rel="tooltip" title="Follow us on Twitter" data-placement="bottom" href="https://www.twitter.com/adventurethon" target="_blank">
                                <i class="fa fa-twitter"></i>
                                <p class="hidden-lg-up">Twitter</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" rel="tooltip" title="Like us on Facebook" data-placement="bottom" href="https://www.facebook.com/AdventurethonAustralia" target="_blank">
                                <i class="fa fa-facebook-square"></i>
                                <p class="hidden-lg-up">Facebook</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" rel="tooltip" title="Follow us on Instagram" data-placement="bottom" href="https://www.instagram.com/adventurethon" target="_blank">
                                <i class="fa fa-instagram"></i>
                                <p class="hidden-lg-up">Instagram</p>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- End Navbar -->
        <div class="page-header" filter-color="orange">
            <div class="page-header-image" style="background-image:url(/public/img/login.jpg)"></div>
            <div class="container">
                <div class="col-md-4 content-center">
                    <div class="card card-login p-4">
                        <form class="form" id='login'>
                            <div class="header header-primary text-center">
                                <div class="logo-container">
                                    <img src="/public/img/advlogo.svg" alt="">
                                </div>
                            </div>
                            <div class="content">
                                <div class='form-group form-group-no-border input-lg'>
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                            <i class="now-ui-icons users_circle-08"></i>
                                        </span>
                                        <input type="text" id='username' class="form-control" placeholder="Username...">
                                    </div>
                                    <span class='form-control-feedback'></span>
                                </div>
                                <div class='form-group form-group-no-border input-lg'>
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                            <i class="now-ui-icons ui-1_lock-circle-open"></i>
                                        </span>
                                        <input type="password" id='password' placeholder="Password..." class="form-control" />
                                    </div>
                                    <span class='form-control-feedback'></span>
                                </div>
                                <div class='form-feedback text-danger text-center pt-5'></div>
                            </div>
                            <div class="footer text-center pt-1 pb-1">
                                <button type='submit' class="btn btn-primary btn-round btn-lg btn-block login">Login</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <footer class="footer">
                <div class="container">
                    <nav>
                        <ul>
                            <li>
                                <a href="https://adventurethon.com.au/">
                                    Adventurethon
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/creativetimofficial/now-ui-kit/blob/master/LICENSE.md">
                                    MIT License
                                </a>
                            </li>
                        </ul>
                    </nav>
                    <div class="copyright">
                        &copy;
                        <script>
                            document.write(new Date().getFullYear())
                        </script>, Adventurethon
                    </div>
                </div>
            </footer>
        </div>
    </body>

    <script src="/public/js/core/jquery.3.2.1.min.js" type="text/javascript"></script>
    <script src="/public/js/core/tether.min.js" type="text/javascript"></script>
    <script src="/public/js/core/bootstrap.min.js" type="text/javascript"></script>
    <script src="/public/js/plugins/bootstrap-switch.js"></script>
    <script src="/public/js/plugins/nouislider.min.js" type="text/javascript"></script>
    <script src="/public/js/plugins/bootstrap-datepicker.js" type="text/javascript"></script>
    <script src="/public/js/now-ui-kit.js" type="text/javascript"></script>
    <script src='/public/js/plugins/jsencrypt.js' type="text/javascript"></script>
    <script src='/public/js/app.js' type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            page.initialise();
        }).on('submit', 'form', function(event) {
            event.preventDefault;
            page.Login($(this));
            return false;
        });

        var page = {
            Login: function($this) {
                $this.find('button.login').prop('disable', true);
                $('.has-danger').removeClass('has-danger');
                $('.form-control-feedback, .form-feedback').html(null);

                var data = {
                    username: $('#username').val().trim(),
                    password: $('#password').val().trim(),
                }

                if (String.isNullOrEmpty(data.username)) {
                    $('#username').closest('.form-group').addClass('has-danger');
                    $('#username').closest('.form-group').find('.form-control-feedback').html('Please enter a username.');
                }
                if (String.isNullOrEmpty(data.password)) {
                    $('#password').closest('.form-group').addClass('has-danger');
                    $('#password').closest('.form-group').find('.form-control-feedback').html('Please enter a password.');
                }

                if ($('.has-danger').length > 0) {
                    $this.find('button.login').prop('disable', false);
                    $.toaster({
                        priority: 'warning', title: 'Error', icon: 'fa fa-close',
                        message: 'Please address the on-screen errors and try again.'
                    });
                } else {
                    $('.form-feedback').html('<p style="color: #000;"><i class="fa fa-spinner fa-pulse fa-2x fa-fw"></i>  Please Wait...</p>');
                    $.getJSON('/key', function(response) {
                        var crypt = new JSEncrypt();
                        crypt.setPublicKey(response.key);
                        data.username = crypt.encrypt(data.username);
                        data.password = crypt.encrypt(data.password);

                        $.ajax('/login', {
                            type: 'POST',
                            dataType: 'JSON',
                            data: data,
                        }).always(function(xhr) {
                            if (xhr.status == 401) {
                                $this.find('button.login').prop('disable', false);
                                $('.form-feedback').html('<p class="text-danger">'+xhr.responseJSON.message+'</p>');
                                $.toaster({
                                    priority: 'danger', title: 'Error', icon: 'fa fa-close',
                                    message: xhr.responseJSON.message,
                                });
                            } else if (xhr.status == 200) {
                                window.setTimeout(function() {
                                    location.reload();
                                }, 250);
                            } else {
                                $this.find('button.login').prop('disable', false);
                                $('.form-feedback').html('<p class="text-danger">A server error occured, please try again.</p>');
                                $.toaster({
                                    priority: 'danger', title: 'Error', icon: 'fa fa-close',
                                    message: 'A server error occured, please try again.'
                                });
                            }
                        });
                    });
                }
            },
        };

        page.initialise = function() {
            console.log('Page Initialised Successfully');
        };
    </script>
</html>
